#!/usr/bin/env bash

usage(){
    echo -e "Start/Attach tmux session."
    echo -e "Usage: ${SCPT_NAME} SESSION"
}

[ "$1" = "--help" -o $# -lt 1 ] && usage && exit 0

SESSION=$1

source "${YATSH_ROOT}/lib/global_helpers.sh"
source "${YATSH_ROOT}/lib/session_helpers.sh"

_find_session_file(){
    local name=$1
    shopt -s nullglob
    for dir in $(_split_path $YATSH_SESSIONS_PATH); do
        for file in "${dir}"/*; do
            [ $(basename $file) = $name ] && echo $file && return 0
        done
    done
    shopt -u nullglob
    return 1
}

# session_file="$(_find_session_file $SESSION)"
# echo $session_file  ; exit
TMUX_OLD=$TMUX
TMUX=
if ! tmux has-session -t $SESSION 2> /dev/null ; then

    session_file="$(_find_session_file $SESSION)"
    if [ -z "$session_file" ]; then
        tmux new-session -d -s $SESSION
    else
        if [ -h $session_file ]; then
            cd $(dirname $(readlink $session_file))
        else
            cd $(dirname $session_file)
        fi
        custom_loader=$(_extract 'LOADER' $session_file)
        if [ ! -z $custom_loader ] && _is_command $custom_loader; then
            echo $custom_loader
            exec yatsh-$custom_loader $SESSION
        else
            source $SESSION
        fi
    fi
fi
if [ "$TMUX_OLD" = "" ]; then
    tmux attach-session -t $SESSION
else
    tmux switch-client -t $SESSION
fi
TMUX=$TMUX_OLD
